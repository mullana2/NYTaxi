---
title: 'Mon12 Analysis'
author: "Aidan Mullan"
date: "4/2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(caret)
library(dplyr)
library(e1071)
library(geohash)
library(stringr)
library(ggplot2)
library(ggmap)
```


```{r}
## Read in data for each year, add year into column names
nd09 <- read.csv("Data/NetDiff_Mon12/netdiff2009.csv")[,-1]
names(nd09) <- c("geohash", "Jan09", "Feb09", "Mar09", "Apr09", "May09", "Jun09", "Jul09", "Aug09",
                 "Sep09", "Oct09", "Nov09", "Dec09")
nd10 <-  read.table("Data/NetDiff_Mon12/netdiff2010", sep = ",", header = TRUE)[,-1]
names(nd10) <- c("geohash", "Jan10", "Feb10", "Mar10", "Apr10", "May10", "Jun10", "Jul10", "Aug10",
                 "Sep10", "Oct10", "Nov10", "Dec10")
temp11_13 <-  read.table("Data/NetDiff_Mon12/netdiff201113,csv", sep = ",", header = TRUE)[,-1]
nd11 <- temp11_13[,1:13]; nd12 <- temp11_13[,c(1,14:25)]; nd13 <- temp11_13[,c(1,26:36)]
names(nd11) <- c("geohash", "Jan11", "Feb11", "Mar11", "Apr11", "May11", "Jun11", "Jul11", "Aug11",
                 "Sep11", "Oct11", "Nov11", "Dec11")
names(nd12) <- c("geohash", "Jan12", "Feb12", "Mar12", "Apr12", "May12", "Jun12", "Jul12", "Aug12",
                 "Sep12", "Oct12", "Nov12", "Dec12")
names(nd13) <- c("geohash", "Jan13", "Feb13", "Mar13", "Apr13", "May13", "Jun13", "Jul13", "Aug13",
                 "Sep13", "Oct13", "Nov13")
nd14 <- read.csv("Data/NetDiff_Mon12/netdiff2014.csv")[,-1]
names(nd14) <- c("geohash", "Jan14", "Feb14", "Mar14", "Apr14", "May14", "Jun14", "Jul14", "Aug14",
                 "Sep14", "Oct14", "Nov14", "Dec14")
nd15 <- read.csv("Data/NetDiff_Mon12/netdiff15.csv")[,-1]
names(nd15) <- c("geohash", "Jan15", "Feb15", "Mar15", "Apr15", "May15", "Jun15", "Jul15", "Aug15",
                 "Sep15", "Oct15", "Nov15", "Dec15")
nd16 <- read.csv("Data/NetDiff_Mon12/netdiff2016")[,-1]
names(nd16) <- c("geohash", "Jan16", "Feb16", "Mar16", "Apr16", "May16", "Jun16")
```

```{r}
## Merge data from each year by geohash ID
nd09_10 <- merge(nd09, nd10, by = "geohash", all = TRUE)
nd09_11 <- merge(nd09_10, nd11, by = "geohash", all = TRUE)
nd09_12 <- merge(nd09_11, nd12, by = "geohash", all = TRUE)
nd09_13 <- merge(nd09_12, nd13, by = "geohash", all = TRUE)
nd09_14 <- merge(nd09_13, nd14, by = "geohash", all = TRUE)
nd09_15 <- merge(nd09_14, nd15, by = "geohash", all = TRUE)
nd09_16 <- merge(nd09_15, nd16, by = "geohash", all = TRUE)

## Identify months where a cell had no data
miss_index <- is.na(nd09_16[,-1])
nd09_16[is.na(nd09_16)] <- 0

## For each cell, count number of months with no data
miss_counts <- 89 - rowSums(miss_index)
full_counts <- which(miss_counts == 89)
half_counts <- which(miss_counts >= 50)

## Retrieve all cells that never missed data
full09_16 <- nd09_16[full_counts,]
half09_16 <- nd09_16[half_counts,]
```

```{r}
## EDA for time series
set.seed(123456)
size <- length(full09_16[,1])
index <- sample(size, 1)
sample <- as.vector(full09_16[index,-1])
plot(1:89,sample[1,1:89], type = "l")


## Analyzing linear trend for all cell time series
trend <- predicts <- numeric(size)
for(i in 1:size){
  counts <- numeric(89)
  for(j in 1:89){
    counts[j] <- full09_16[i,j+1]
  }
  time <- 1:89
  trend_model <- lm(counts~time)
  trend[i] <- trend_model$coef[2]
  #predict_model <- lm(counts[-89]~time[-89])
  #predicts[i] <- predict_model$coef[1] + 89*predict_model$coef[2]
}
summary(trend)
hist(trend, breaks = 30)
#mse_predict <- mean((full09_16[,90] - predicts)^2) ## 182.918

## Plotting TS for mix/max linear trend
max_cell <- full09_16[which.max(trend),]
plot(1:89,max_cell[2:90], type = "l")
min_cell <- full09_16[which.min(trend),]
plot(1:89,min_cell[2:90], type = "l")
```

```{r}
## Basic KNN to predict June 2016
MayJun_16 <- nd09_16[,c(1,89,90)]
hashes <- gh_decode(Jun_16$geohash)
MayJun_16$Longitude <- scale(hashes$lng)
MayJun_16$Latitude <- scale(hashes$lat)

size <- length(Jun_16[,1])
train_size <- size * 0.8
train_index <- sample(size, train_size)
train_data <- MayJun_16[train_index,]
test_data <- MayJun_16[-train_index,]

Jun16_control <- trainControl(method = "cv", number = 10, classProbs = TRUE)
Jun16_knn <- train(Jun16~Longitude+Latitude, data = train_data, method = "knn",
                trControl = Jun16_control, tuneGrid = expand.grid(k = c(4,8,12,20,24)), metric = "RMSE")
Jun16_knn # k = 4, RMSE = 9.701, Rsq = 0.544

Jun16_preds <- predict(Jun16_knn, newdata = test_data)
sqrt(mean((test_data$Jun16 - Jun16_preds)^2)) # 14.462

#####---------------------------------
## Using May 2016 to predict June 2016
MayJun16_knn <- train(May16~Longitude+Latitude, data = MayJun_16, method = "knn",
                trControl = Jun16_control, tuneGrid = expand.grid(k = c(4,8,12,20,24)), metric = "RMSE")
MayJun16_knn # k = 4, RMSE = 12.772, Rsq = 0.550

MayJun_preds <- predict(MayJun16_knn, newdata = MayJun_16[,3:5])
sqrt(mean((MayJun_16$Jun16 - MayJun_preds)^2)) # RMSE = 20.642

MayJun_preds2 <- predict(MayJun16_knn, newdata = test_data)
sqrt(mean((test_data$Jun16 - MayJun_preds2)^2)) # RMSE = 9.437

#####-------------------------------------
## Using Average from 2009-2016: All Months

MayJun_16$AllMeans <- rowMeans(nd09_16[,-c(1,90)])
AllMeans_knn <- train(AllMeans~Longitude+Latitude, data = MayJun_16, method = "knn",
                trControl = Jun16_control, tuneGrid = expand.grid(k = c(4,8,12,20,24)), metric = "RMSE")
AllMeans_knn # k = 4, RMSE = 11.619, Rsq = 0.643

AllMeans_preds <- predict(AllMeans_knn, newdata = MayJun_16[,3:5])
sqrt(mean((MayJun_16$Jun16 - AllMeans_preds)^2)) # RMSE = 9.569

AllMeans_preds2 <- predict(AllMeans_knn, newdata = test_data)
sqrt(mean((test_data$Jun16 - AllMeans_preds2)^2)) # RMSE = 10.034

#####-------------------------------------
## Using Average from 2009-2016: June Only

MayJun_16$JuneMeans <- rowMeans(nd09_16[,c(7,19,31,43,55,66,78)])
JuneMeans_knn <- train(JuneMeans~Longitude+Latitude, data = MayJun_16, method = "knn",
                trControl = Jun16_control, tuneGrid = expand.grid(k = c(4,8,12,20,24)), metric = "RMSE")
JuneMeans_knn # k = 4, RMSE = 12.209, Rsq = 0.664

JuneMeans_preds <- predict(JuneMeans_knn, newdata = MayJun_16[,3:5])
sqrt(mean((MayJun_16$Jun16 - JuneMeans_preds)^2)) # RMSE = 10.428

JuneMeans_preds2 <- predict(JuneMeans_knn, newdata = test_data)
sqrt(mean((test_data$Jun16 - JuneMeans_preds2)^2)) # RMSE = 10.944
```

```{r}
## Determining RSME for Prediction of All 2016 Months under 3 Methods

Months16 <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun")
RMSE <- data.frame(Prev_Month = numeric(6), AllMeans = numeric(6), MonthMeans = numeric(6))
i = 1
for(month in Months16){
  test_name <- str_c(month, "16")
  test_id <- which(names(nd09_16) == test_name)
  prev_id <- test_id-1
  model_data <- nd09_16[,c(1,prev_id, test_id)]
  names(model_data) <- c("geohash", "Prev_Month", "Test_Month")
  
  hashes <- gh_decode(model_data$geohash)
  model_data$Longitude <- scale(hashes$lng)
  model_data$Latitude <- scale(hashes$lat)
  
  model_data$AllMeans <- rowMeans(nd09_16[,2:prev_id])
  all_months <- str_detect(names(nd09_16)[-c(85:90)], month)
  model_data$MonthMeans <- rowMeans(nd09_16[,all_months])
  
  control <- trainControl(method = "cv", number = 10, classProbs = TRUE)
  PMonth_knn <- train(Prev_Month~Longitude+Latitude, data = model_data, method = "knn",
                trControl = control, tuneGrid = expand.grid(k = c(4,8,12,20,24)), metric = "RMSE")
  AllMeans_knn <- train(AllMeans~Longitude+Latitude, data = model_data, method = "knn",
                trControl = control, tuneGrid = expand.grid(k = c(4,8,12,20,24)), metric = "RMSE")
  MonthMeans_knn <- train(MonthMeans~Longitude+Latitude, data = model_data, method = "knn",
                trControl = control, tuneGrid = expand.grid(k = c(4,8,12,20,24)), metric = "RMSE")
  
  PMonth_preds <- predict(PMonth_knn, newdata = model_data[,3:5])
  RMSE$Prev_Month[i] <- sqrt(mean((model_data$Test_Month - PMonth_preds)^2))
  AllMeans_preds <- predict(AllMeans_knn, newdata = model_data[,3:5])
  RMSE$AllMeans[i] <- sqrt(mean((model_data$Test_Month - AllMeans_preds)^2))
  MonthMeans_preds <- predict(MonthMeans_knn, newdata = model_data[,3:5])
  RMSE$MonthMeans[i] <- sqrt(mean((model_data$Test_Month - MonthMeans_preds)^2))
  i <- i + 1
}

```

```{r}
## Visual Comparison of Observed and Predicted Net Diff

MayJun_16$AllMeans <- rowMeans(nd09_16[,-c(1,90)])
AllMeans_knn <- train(AllMeans~Longitude+Latitude, data = MayJun_16, method = "knn",
                trControl = Jun16_control, tuneGrid = expand.grid(k = c(4,8,12,20,24)), metric = "RMSE")

MayJun_16$JunePreds <- predict(AllMeans_knn, newdata = MayJun_16[,3:5])

mlat <- mean(MayJun_16$Latitude)
mlon <- mean(MayJun_16$Longitude)
map_raw <- get_map(location = c(mlon, mlat), zoom = 11, scale = 2)
map <- ggmap(map_raw, legend = "none")

observed_map <- map + geom_point(data = MayJun_16, size = 0.03, na.rm = TRUE, shape = 0,
                                       aes(x = Longitude, y = Latitude, color = Jun16)) + 
  scale_color_manual(values = c("lightcoral", "darkred"), name = "Net Pickups") +
  #scale_color_gradient2(low = "lightpink", mid = "darkred", high = "darkred", midpoint = 10) +
  ggtitle("Figure 3a: Geohash Map of Pickups > Dropoffs, June 2016 (12-12:30PM)") +
  xlab("") + ylab("") +
  theme(axis.line = element_blank(), axis.text = element_blank(),
        axis.ticks = element_blank(), plot.title = element_text(size = 5),
        legend.title = element_text(size = 5), legend.text = element_text(size = 4))
```








